name: Deploy on tag (docker-compose)

on:
  push:
    tags:
      - 'v*.*.*'
      - '*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
      LARAVEL_SERVICE: ${{ secrets.LARAVEL_SERVICE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag
        run: echo "TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"

      - name: Prepare SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          SSH_PORT="${SSH_PORT:-22}"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Sync release to server
        run: |
          set -euo pipefail
          SSH_PORT="${SSH_PORT:-22}"
          RELEASE_DIR="$DEPLOY_PATH/releases/$TAG"
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "mkdir -p '$RELEASE_DIR'"
          rsync -az --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude 'vendor' \
            -e "ssh -p $SSH_PORT" \
            ./ "$SSH_USER@$SSH_HOST:$RELEASE_DIR/"

      - name: Deploy with Docker Compose
        run: |
          set -euo pipefail
          SSH_PORT="${SSH_PORT:-22}"
          ssh -p "$SSH_PORT" \
            "$SSH_USER@$SSH_HOST" \
            "TAG='$TAG' DEPLOY_PATH='$DEPLOY_PATH' HEALTHCHECK_URL='$HEALTHCHECK_URL' LARAVEL_SERVICE='${LARAVEL_SERVICE:-api}' bash -s" <<'EOF'
          set -euo pipefail
          RELEASE_DIR="$DEPLOY_PATH/releases/$TAG"
          CURRENT_LINK="$DEPLOY_PATH/current"
          LARAVEL_SERVICE="${LARAVEL_SERVICE:-api}"

          ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"
          cd "$CURRENT_LINK"

          docker compose pull --quiet || true
          docker compose up -d --build

          docker compose exec -T "$LARAVEL_SERVICE" php artisan migrate --force
          docker compose exec -T "$LARAVEL_SERVICE" php artisan config:cache
          docker compose exec -T "$LARAVEL_SERVICE" php artisan route:cache
          docker compose exec -T "$LARAVEL_SERVICE" php artisan view:cache

          curl -fsS "$HEALTHCHECK_URL" > /dev/null

          if [ -d "$DEPLOY_PATH/releases" ]; then
            cd "$DEPLOY_PATH/releases"
            ls -1dt */ | tail -n +6 | xargs -r rm -rf
          fi
          EOF
